<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.future.my.dao.UserDAO">
    
    <!-- 사용자 회원가입 -->
    <insert id="insertUser" parameterType="com.future.my.vo.UserVO">
        INSERT INTO TASHU_USER (
            USER_ID, NAME, EMAIL, PHONE, PASSWORD, ROLE,
            TOTAL_DISTANCE, TOTAL_RIDES, TOTAL_POINTS, CO2_SAVED,
            CREATE_DATE, UPDATE_DATE
        ) VALUES (
            #{userId}, #{name}, #{email}, #{phone}, #{password}, #{role},
            #{totalDistance}, #{totalRides}, #{totalPoints}, #{co2Saved},
            TO_DATE(#{createDate}, 'YYYY-MM-DD HH24:MI:SS'),
            TO_DATE(#{updateDate}, 'YYYY-MM-DD HH24:MI:SS')
        )
    </insert>
    
    <!-- 사용자 ID로 조회 -->
    <select id="selectUserById" parameterType="string" resultType="com.future.my.vo.UserVO">
        SELECT 
            USER_ID as userId,
            NAME as name,
            EMAIL as email,
            PHONE as phone,
            PASSWORD as password,
            ROLE as role,
            TOTAL_DISTANCE as totalDistance,
            TOTAL_RIDES as totalRides,
            TOTAL_POINTS as totalPoints,
            CO2_SAVED as co2Saved,
            TO_CHAR(CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') as createDate,
            TO_CHAR(UPDATE_DATE, 'YYYY-MM-DD HH24:MI:SS') as updateDate,
            PROFILE_IMAGE as profileImage
        FROM TASHU_USER WHERE USER_ID = #{userId}
    </select>
    
    <!-- 이메일로 사용자 조회 -->
    <select id="selectUserByEmail" parameterType="string" resultType="com.future.my.vo.UserVO">
        SELECT 
            USER_ID as userId,
            NAME as name,
            EMAIL as email,
            PHONE as phone,
            PASSWORD as password,
            ROLE as role,
            TOTAL_DISTANCE as totalDistance,
            TOTAL_RIDES as totalRides,
            TOTAL_POINTS as totalPoints,
            CO2_SAVED as co2Saved,
            TO_CHAR(CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') as createDate,
            TO_CHAR(UPDATE_DATE, 'YYYY-MM-DD HH24:MI:SS') as updateDate,
            PROFILE_IMAGE as profileImage
        FROM TASHU_USER WHERE EMAIL = #{email}
    </select>
    
    <!-- 모든 사용자 조회 -->
    <select id="selectAllUsers" resultType="com.future.my.vo.UserVO">
        SELECT * FROM TASHU_USER ORDER BY USER_ID DESC
    </select>
    
    <!-- 사용자 정보 수정 -->
    <update id="updateUser" parameterType="com.future.my.vo.UserVO">
        UPDATE TASHU_USER SET
            NAME = #{name},
            PROFILE_IMAGE = #{profileImage}
        WHERE USER_ID = #{userId}
    </update>
    
    <!-- 사용자 삭제 (연관 데이터 먼저 삭제) -->
    <delete id="deleteUser" parameterType="string">
        <!-- 1. 라이딩 기록 삭제 -->
        DELETE FROM TASHU_RIDE WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 사용자 관련 모든 데이터 삭제 -->
    <delete id="deleteUserWithRelatedData" parameterType="string">
        <!-- 1. 라이딩 기록 삭제 -->
        DELETE FROM TASHU_RIDE WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 게시글 댓글 삭제 (테이블이 존재하는 경우에만) -->
    <delete id="deleteUserComments" parameterType="string">
        DELETE FROM TASHU_COMMENT WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 게시글 삭제 (테이블이 존재하는 경우에만) -->
    <delete id="deleteUserBoards" parameterType="string">
        DELETE FROM TASHU_BOARD WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 게시글 조회 기록 삭제 (테이블이 존재하는 경우에만) -->
    <delete id="deleteUserBoardViews" parameterType="string">
        DELETE FROM TASHU_BOARD_VIEW WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 게시글 좋아요 삭제 (누락된 테이블!) -->
    <delete id="deleteUserBoardLikes" parameterType="string">
        DELETE FROM TASHU_BOARD_LIKE WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 즐겨찾기 삭제 -->
    <delete id="deleteUserFavorites" parameterType="string">
        DELETE FROM TASHU_FAVORITE WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 랭킹 삭제 -->
    <delete id="deleteUserRankings" parameterType="string">
        DELETE FROM TASHU_RANKING WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 사용자 삭제 -->
    <delete id="deleteUserAccount" parameterType="string">
        DELETE FROM TASHU_USER WHERE USER_ID = #{userId}
    </delete>
    
    <!-- 외래키 참조를 NULL로 설정 -->
    <update id="setUserReferencesToNull" parameterType="string">
        UPDATE TASHU_RIDE SET USER_ID = NULL WHERE USER_ID = #{userId}
    </update>
    
    <!-- 사용자 통계 업데이트 -->
    <update id="updateUserStats" parameterType="com.future.my.vo.UserVO">
        UPDATE TASHU_USER SET
            NAME = #{name}
        WHERE USER_ID = #{userId}
    </update>
    
    <!-- 중복 체크 쿼리들 -->
    <!-- 이름 중복 체크 -->
    <select id="checkNameDuplicate" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM TASHU_USER WHERE NAME = #{name}
    </select>
    
    <!-- 이메일 중복 체크 -->
    <select id="checkEmailDuplicate" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM TASHU_USER WHERE EMAIL = #{email}
    </select>
    
    <!-- 전화번호 중복 체크 -->
    <select id="checkPhoneDuplicate" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM TASHU_USER WHERE PHONE = #{phone}
    </select>
    
</mapper>